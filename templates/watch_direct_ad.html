<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Direct Ad - ZMWORLD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .timer-circle {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
            border: 4px solid #eab308;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 32px;
            color: #92400e;
            margin: 0 auto;
        }
        .ad-container {
            min-height: 400px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white py-4 mb-6">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">📺 Direct Ad Watch</h1>
                    <p class="text-blue-100 mt-1">Watch the ad for 40 seconds to earn coins!</p>
                </div>
                <div class="text-right">
                    <a href="{{ url_for('dashboard') }}" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 md:px-4 md:py-2 rounded-lg transition duration-200 text-sm md:text-base">
                        🏠 Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 max-w-4xl">
        <!-- Timer and Status -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 text-center">
            <div class="timer-display mb-6" id="mainTimer">
                <div class="progress-circle" id="countdown">40</div>
                <div class="mt-3 text-lg">Select an ad below to start</div>
            </div>

            <div id="statusMessage" class="hidden bg-blue-100 text-blue-800 p-3 rounded-lg mb-4">
                <p>Waiting for ad to load properly...</p>
            </div>
        </div>

        <!-- Multiple Ad Buttons -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-lg font-bold mb-4 text-center">🎯 Choose an Ad Network</h3>
            <div id="adButtonsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center text-gray-500 p-8">
                    <div class="text-4xl mb-2">⏳</div>
                    <p>Loading ad networks...</p>
                </div>
            </div>
        </div>

        <!-- Ad Display -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-lg font-bold mb-4 text-center">📺 Direct Ad Player</h3>
            <div id="adContainer" class="border-2 border-dashed border-gray-300 rounded-lg h-96 flex items-center justify-center">
                <div class="text-center text-gray-500">
                    <div class="text-4xl mb-2">📺</div>
                    <p>Select an ad network above to start watching</p>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-gradient-to-r from-blue-50 to-yellow-50 rounded-xl p-6">
            <h3 class="text-lg font-bold mb-3 text-gray-800">📋 Instructions</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <span class="mr-2">🔹</span>
                            Wait for the full 40-second countdown
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2">🔹</span>
                            Do not close or refresh this page
                        </li>
                    </ul>
                </div>
                <div>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <span class="mr-2">🔸</span>
                            Interact with the ad if required
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2">🔸</span>
                            Earn coins automatically after completion
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let timeLeft = 40;
        let isAdStarted = false;
        let adStartTime = null;
        let sessionToken = null;
        let isWatching = false;
        let adLinks = [];
        let selectedAdUrl = '';
        let adLoaded = false;

        // Load ad links on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAdLinks();
        });

        function loadAdLinks() {
            fetch('/api/get-ad-links')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.ad_links.length > 0) {
                    adLinks = data.ad_links;
                    displayAdButtons();
                } else {
                    document.getElementById('adButtonsContainer').innerHTML = `
                        <div class="text-center text-red-500 p-8 col-span-full">
                            <div class="text-4xl mb-2">❌</div>
                            <p>No ad networks configured. Please contact admin.</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading ad links:', error);
                document.getElementById('adButtonsContainer').innerHTML = `
                    <div class="text-center text-red-500 p-8 col-span-full">
                        <div class="text-4xl mb-2">⚠️</div>
                        <p>Error loading ad networks. Please refresh.</p>
                    </div>
                `;
            });
        }

        function displayAdButtons() {
            const container = document.getElementById('adButtonsContainer');
            let buttonsHtml = '';

            adLinks.forEach((link, index) => {
                buttonsHtml += `
                    <button onclick="selectAd('${link.url}', '${link.name}')" 
                            class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-bold py-4 px-6 rounded-lg transition duration-200 shadow-lg">
                        📱 ${link.name}
                    </button>
                `;
            });

            container.innerHTML = buttonsHtml;
        }

        function selectAd(adUrl, adName) {
            if (isWatching) {
                showNotification('Please wait for current ad to complete.', 'error');
                return;
            }

            selectedAdUrl = adUrl;
            adLoaded = false;

            // Start ad session
            startDirectAdSession(adName);
        }

        function startDirectAdSession(adName) {
            fetch('/start-direct-ad-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionToken = data.session_token;
                    isWatching = true;

                    // Update status
                    document.getElementById('statusMessage').classList.remove('hidden');
                    document.querySelector('#mainTimer .mt-3').textContent = `Loading ${adName}...`;

                    // Load ad in iframe
                    loadDirectAdInIframe();

                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to start ad session. Please try again.', 'error');
            });
        }

        function loadDirectAdInIframe() {
            const adContainer = document.getElementById('adContainer');
            const iframe = document.createElement('iframe');
            iframe.src = selectedAdUrl;
            iframe.className = 'w-full h-full border-0 rounded-lg';
            iframe.onload = function() {
                adLoaded = true;
                document.getElementById('statusMessage').classList.add('hidden');
                document.querySelector('#mainTimer .mt-3').textContent = 'Ad loaded! Timer starting...';
                setTimeout(() => {
                    startCountdown();
                }, 2000); // Wait 2 seconds after load before starting timer
            };
            iframe.onerror = function() {
                showNotification('Failed to load ad. Please try another network.', 'error');
                resetAdSystem();
            };

            adContainer.innerHTML = '';
            adContainer.appendChild(iframe);
        }

        function updateTimer() {
            const countdownElement = document.getElementById('countdown');
            const statusElement = document.getElementById('status');

            countdownElement.textContent = timeLeft;

            if (timeLeft > 0) {
                if (isAdStarted) {
                    statusElement.textContent = `⏰ ${timeLeft} seconds remaining...`;
                } else {
                    statusElement.textContent = `📺 Ad starting in ${timeLeft} seconds...`;
                }
                timeLeft--;
            } else {
                statusElement.textContent = '✅ Ad completed! You can close this page.';
                countdownElement.textContent = '✅';
                countdownElement.style.background = 'linear-gradient(135deg, #dcfce7 0%, #86efac 100%)';
                countdownElement.style.borderColor = '#22c55e';
                countdownElement.style.color = '#15803d';

                // Show completion message
                showCompletionMessage();
            }
        }

        function startAd() {
            // Start ad session first
            fetch('/start-direct-ad-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionToken = data.session_token;
                    isAdStarted = true;
                    adStartTime = new Date();

                    loadRandomAd();
                } else {
                    document.getElementById('status').textContent = '❌ Error starting ad session: ' + data.message;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('status').textContent = '❌ Network error. Please refresh and try again.';
            });
        }

        function loadRandomAd() {
            // Load dynamic ad code from backend
            fetch('/api/get-direct-ad-code')
                .then(response => response.json())
                .then(data => {
                    const adContainer = document.getElementById('adContainer');
                    if (data.success && data.ad_code) {
                        adContainer.innerHTML = data.ad_code;

                        // Execute any scripts in the ad code
                        const scripts = adContainer.querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            if (script.src) {
                                newScript.src = script.src;
                            } else {
                                newScript.textContent = script.textContent;
                            }
                            document.head.appendChild(newScript);
                        });
                    } else {
                        // Fallback to default ad
                        adContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <h3 style="color: #333;">Advertisement</h3>
                                <p style="color: #666;">Ad content will load here</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading ad:', error);
                    const adContainer = document.getElementById('adContainer');
                    adContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <h3 style="color: #333;">Advertisement</h3>
                            <p style="color: #666;">Loading ad content...</p>
                        </div>
                    `;
                });

            // Reset timer to 40 seconds for actual ad watching
            timeLeft = 40;
        }

        function showCompletionMessage() {
            // Award coins via API call
            if (sessionToken && adStartTime) {
                fetch('/complete-direct-ad-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_token: sessionToken,
                        watch_time: Math.floor((new Date() - adStartTime) / 1000)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const adContainer = document.getElementById('adContainer');
                    if (data.success) {
                        adContainer.innerHTML = `
                            <div class="flex items-center justify-center h-full">
                                <div class="text-center">
                                    <div class="text-6xl mb-4">🎉</div>
                                    <h3 class="text-xl font-bold text-green-600 mb-2">Task Completed!</h3>
                                    <p class="text-green-600 font-semibold mb-2">+0.5 Coins Earned!</p>
                                    <p class="text-gray-600 mb-4">New Balance: ${data.new_balance} coins</p>
                                    <a href="{{ url_for('dashboard') }}" 
                                       class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200 font-semibold">
                                        🏠 Return to Dashboard
                                    </a>
                                </div>
                            </div>
                        `;
                    } else {
                        adContainer.innerHTML = `
                            <div class="flex items-center justify-center h-full">
                                <div class="text-center">
                                    <div class="text-4xl mb-4">❌</div>
                                    <h3 class="text-xl font-bold text-red-600 mb-2">Error</h3>
                                    <p class="text-gray-600 mb-4">${data.message}</p>
                                    <a href="{{ url_for('watch_direct_ad') }}" 
                                       class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold">
                                        🔄 Try Again
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const adContainer = document.getElementById('adContainer');
                    adContainer.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <div class="text-4xl mb-4">⚠️</div>
                                <h3 class="text-xl font-bold text-yellow-600 mb-2">Network Error</h3>
                                <p class="text-gray-600 mb-4">Please check your connection and try again.</p>
                                <a href="{{ url_for('dashboard') }}" 
                                   class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold">
                                    🏠 Return to Dashboard
                                </a>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // Start countdown immediately
        const timer = setInterval(() => {
            updateTimer();

            // Start ad after 3 seconds
            if (!isAdStarted && timeLeft === 37) {
                startAd();
            }

            // Stop timer when complete
            if (timeLeft < 0) {
                clearInterval(timer);
            }
        }, 1000);

        // Initial display
        updateTimer();

        // Prevent page refresh during ad
        window.addEventListener('beforeunload', function(e) {
            if (isAdStarted && timeLeft > 0) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your ad progress and coin reward will be lost.';
            }
        });

        function showNotification(message, type = 'info') {
            alert(message); // Replace with a better notification system if needed
        }

        function resetAdSystem() {
            isWatching = false;
            sessionToken = null;
            selectedAdUrl = '';
            adLoaded = false;
            document.getElementById('statusMessage').classList.add('hidden');
            document.querySelector('#mainTimer .mt-3').textContent = 'Select an ad below to start';
            document.getElementById('adContainer').innerHTML = `
                <div class="text-center text-gray-500">
                    <div class="text-4xl mb-2">📺</div>
                    <p>Select an ad network above to start watching</p>
                </div>
            `;
        }

        function startCountdown() {
            timeLeft = 40;
            isAdStarted = true;
            adStartTime = new Date();
            const countdownElement = document.getElementById('countdown');
            const statusElement = document.getElementById('status');
             const timer = setInterval(() => {
            updateTimer();

            // Stop timer when complete
            if (timeLeft < 0) {
                clearInterval(timer);
            }
        }, 1000);
        }
    </script>
</body>
</html>